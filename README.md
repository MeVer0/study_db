# üöÄ –ü—Ä–æ–µ–∫—Ç: –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å SQL-–∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–µ–ª–µ–π, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è.

## üìÅ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- `vehicles.sql` ‚Äî SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞"
- `car_racing.sql` ‚Äî SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π "–ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ –≥–æ–Ω–∫–∏"
- `organizational_structure.sql` ‚Äî SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–µ–ª–µ–π"
- `hotel_booking.sql` ‚Äî SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"

## üß∞ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

1. **–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**  
   –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–≤–æ–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL (–∏–ª–∏ –¥—Ä—É–≥–æ–π –°–£–ë–î) –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã, –∏—Å–ø–æ–ª—å–∑—É—è SQL-–∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ñ–∞–π–ª–æ–≤.

2. **–ò–º–ø–æ—Ä—Ç –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö**  
   –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –≤–∞—à–µ–π SQL-–∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## üßæ SQL-–∑–∞–ø—Ä–æ—Å—ã

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã SQL-–∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–¥–∞–Ω–∏—è. –û–Ω–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö


### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö 1. –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
```sql
---–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π (maker) –∏ –º–æ–¥–µ–ª–∏ –≤—Å–µ—Ö –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤,
-- –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –º–æ—â–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ 150 –ª–æ—à–∞–¥–∏–Ω—ã—Ö —Å–∏–ª, —Å—Ç–æ—è—Ç –º–µ–Ω–µ–µ
-- 20 —Ç—ã—Å—è—á –¥–æ–ª–ª–∞—Ä–æ–≤ –∏ —è–≤–ª—è—é—Ç—Å—è —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–º–∏ (—Ç–∏–ø Sport).
-- –¢–∞–∫–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –º–æ—â–Ω–æ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è.
select v.maker, v.model
from
    motorcycle m
        join vehicle v on m.model = v.model
        and m.type = 'Sport'
        and m.horsepower > 150
        and m.price < 20000;


---–ù–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è—Ö –∏ –º–æ–¥–µ–ª—è—Ö —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤
-- —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ (–∞–≤—Ç–æ–º–æ–±–∏–ª–∏, –º–æ—Ç–æ—Ü–∏–∫–ª—ã –∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã),
-- –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º.
select * from
(select
    v.maker, v.model, c.horsepower, c.engine_capacity, v.type
    from
        vehicle v
join car c on v.model = c.model
            and c.horsepower > 150
            and c.engine_capacity < 3
            and c.price <35000

union

select
    v.maker, v.model, m.horsepower, m.engine_capacity, v.type
from
    vehicle v
join motorcycle m on v.model = m.model
            and m.horsepower > 150
            and m.engine_capacity < 1.5
            and m.price <20000

union

select
    v.maker, v.model, null, null, v.type
from
    vehicle v
join bicycle b on v.model = b.model
            and b.gear_count > 18
            and b.price < 4000
    ) as qs
order by qs.horsepower desc NULLS LAST
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö 2 . –ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ –≥–æ–Ω–∫–∏
```sql
--–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏–∑ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏–º–µ—é—Ç –Ω–∞–∏–º–µ–Ω—å—à—É—é —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é –≤ –≥–æ–Ω–∫–∞—Ö, –∏
-- –≤—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —Ç–∞–∫–æ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞, –≤–∫–ª—é—á–∞—è –µ–≥–æ –∫–ª–∞—Å—Å,
-- —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–Ω–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω —É—á–∞—Å—Ç–≤–æ–≤–∞–ª.
-- –¢–∞–∫–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å—Ä–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏.
select c.name car_name, c.class car_class, avg(r.position) average_position, count(c.name) race_count
    from
        cars c
join results r on c.name = r.car
group by c.name, c.class
order by average_position, car_class;


--–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –Ω–∞–∏–º–µ–Ω—å—à—É—é —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é –≤ –≥–æ–Ω–∫–∞—Ö —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π,
-- –∏ –≤—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç—Ç–æ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ, –≤–∫–ª—é—á–∞—è –µ–≥–æ –∫–ª–∞—Å—Å, —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–Ω–æ–∫,
-- –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω —É—á–∞—Å—Ç–≤–æ–≤–∞–ª, –∏ —Å—Ç—Ä–∞–Ω—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è. –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
-- –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –Ω–∞–∏–º–µ–Ω—å—à—É—é —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é, –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ø–æ –∏–º–µ–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è).
select c.name car_name, c.class car_class, avg(r.position) average_position, count(c.name) race_count, c_inf.country
from
    cars c
        join results r on c.name = r.car
join classes c_inf on c.class = c_inf.class
group by c.name, c.class, c_inf.country
order by average_position, car_class
limit 1;


--–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∞—Å—Å—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –Ω–∞–∏–º–µ–Ω—å—à—É—é —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é –≤ –≥–æ–Ω–∫–∞—Ö, –∏ –≤—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
-- –æ –∫–∞–∂–¥–æ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ –∏–∑ —ç—Ç–∏—Ö –∫–ª–∞—Å—Å–æ–≤, –≤–∫–ª—é—á–∞—è –µ–≥–æ –∏–º—è, —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–Ω–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω
-- —É—á–∞—Å—Ç–≤–æ–≤–∞–ª, —Å—Ç—Ä–∞–Ω—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∞ —Ç–∞–∫–∂–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–Ω–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏
-- –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —ç—Ç–∏—Ö –∫–ª–∞—Å—Å–æ–≤. –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∞—Å—Å–æ–≤ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é, –≤—ã–±—Ä–∞—Ç—å –≤—Å–µ –∏–∑ –Ω–∏—Ö.
with RankedClasses as (
    select c_int.class,
           avg(r.position) avg_pos,
           count(r.car) races_count,
           rank() over (order by avg(r.position)) rank
    from classes c_int
             join cars c on c_int.class = c.class
             join results r on c.name = r.car
    group by c_int.class
),
     ClassTotalRaces as (
         select count(*) total_races,
                rc.class
         from
             cars
                 join results on cars.name = results.car
                 join races on results.race = races.name
                 join RankedClasses rc on cars.class = rc.class
         group by rc.class
     )
select
    c.name,
    rc.class,
    rc.avg_pos,
    rc.races_count,
    c_inf.country,
    ctr.total_races
from
    RankedClasses rc
        join ClassTotalRaces ctr on ctr.class = rc.class
        join cars c on rc.class = c.class
        join classes c_inf on c.class = c_inf.class
where rc.rank = 1;


--–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏–º–µ—é—Ç —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é –ª—É—á—à–µ (–º–µ–Ω—å—à–µ) —Å—Ä–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏
-- –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ —Å–≤–æ–µ–º –∫–ª–∞—Å—Å–µ (—Ç–æ –µ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–ª–∞—Å—Å–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º –¥–≤–∞,
-- —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö). –í—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç—Ç–∏—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª—è—Ö, –≤–∫–ª—é—á–∞—è –∏—Ö –∏–º—è,
-- –∫–ª–∞—Å—Å, —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–Ω–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω–∏ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏, –∏ —Å—Ç—Ä–∞–Ω—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
-- –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è. –¢–∞–∫–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–ª–∞—Å—Å—É –∏ –∑–∞—Ç–µ–º –ø–æ —Å—Ä–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏
-- –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è.
select qs.name cars_name,
       qs.class car_class,
       qs.average_position,
       qs.race_count,
       c.country
    from (
             select cars.name,
                    classes.class,
                    avg(results.position) average_position,
                    count(results.*) race_count,
                    rank() over (partition by cars.class order by avg(results.position)) rank,
                    count(cars.name) over (partition by cars.class)                      cars_into_class
             from classes
                      join cars on classes.class = cars.class
                      join results on cars.name = results.car
             group by cars.name, classes.class
         ) qs
    join classes c on qs.class = c.class
where qs.rank = 1 and qs.cars_into_class > 1;



---–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–∏–µ –∫–ª–∞—Å—Å—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–º–µ—é—Ç –Ω–∞–∏–±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å –Ω–∏–∑–∫–æ–π —Å—Ä–µ–¥–Ω–µ–π
-- –ø–æ–∑–∏—Ü–∏–µ–π (–±–æ–ª—å—à–µ 3.0) –∏ –≤—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ –∏–∑ —ç—Ç–∏—Ö –∫–ª–∞—Å—Å–æ–≤, –≤–∫–ª—é—á–∞—è –µ–≥–æ –∏–º—è,
-- –∫–ª–∞—Å—Å, —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–Ω–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω —É—á–∞—Å—Ç–≤–æ–≤–∞–ª, —Å—Ç—Ä–∞–Ω—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∫–ª–∞—Å—Å–∞
-- –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∞ —Ç–∞–∫–∂–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–Ω–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞. –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
-- –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å –Ω–∏–∑–∫–æ–π —Å—Ä–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–µ–π.
with carsAvgResult as (select cars.name car_name,
                              cars.class car_class,
                              avg(results.position) average_position,
                              count(results.*) race_count
                       from classes
                                join cars on classes.class = cars.class
                                join results on cars.name = results.car
                       group by cars.name, cars.class
                       having avg(results.position) > 3),
totalClassRacesCount as (
    select
        carsAvgResult.car_class,
        count(races.*) total_races
    from races
        join results on races.name = results.race
    join cars on results.car = cars.name
    join carsAvgResult on carsAvgResult.car_class = cars.class
    group by carsAvgResult.car_class
)
    select
        carsAvgResult.car_name,
        carsAvgResult.car_class,
        carsAvgResult.average_position,
        carsAvgResult.race_count,
        classes.country,
        totalClassRacesCount.total_races

from
classes
join carsAvgResult on carsAvgResult.car_class = classes.class
join totalClassRacesCount on totalClassRacesCount.car_class = carsAvgResult.car_class;
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö 3. –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–µ–ª–µ–π
```sql
--–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–∏–µ –∫–ª–∏–µ–Ω—Ç—ã —Å–¥–µ–ª–∞–ª–∏ –±–æ–ª–µ–µ –¥–≤—É—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö –æ—Ç–µ–ª—è—Ö, –∏ –≤—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
-- –æ –∫–∞–∂–¥–æ–º —Ç–∞–∫–æ–º –∫–ª–∏–µ–Ω—Ç–µ, –≤–∫–ª—é—á–∞—è –µ–≥–æ –∏–º—è, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –ø–æ—á—Ç—É, —Ç–µ–ª–µ—Ñ–æ–Ω, –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π,
-- –∞ —Ç–∞–∫–∂–µ —Å–ø–∏—Å–æ–∫ –æ—Ç–µ–ª–µ–π, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ –Ω–æ–º–µ—Ä–∞ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ –ø–æ–ª–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é —Å –ø–æ–º–æ—â—å—é CONCAT).
-- –¢–∞–∫–∂–µ –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—Ä–µ–¥–Ω—é—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏—Ö –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è (–≤ –¥–Ω—è—Ö) –ø–æ –≤—Å–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º.
-- –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è.
SELECT
    c.name,
    c.email,
    c.phone,
    COUNT(b.ID_booking) AS total_bookings,
    STRING_AGG(DISTINCT h.name, ', ') AS hotel_list,
    ROUND(AVG(b.check_out_date - b.check_in_date), 4) AS avg_stay_duration
FROM Booking b
         JOIN Customer c ON b.ID_customer = c.ID_customer
         JOIN Room r ON b.ID_room = r.ID_room
         JOIN Hotel h ON r.ID_hotel = h.ID_hotel
GROUP BY c.ID_customer
HAVING COUNT(DISTINCT h.ID_hotel) > 1  AND COUNT(b.ID_booking) >= 3
ORDER BY total_bookings DESC;


--–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–¥–µ–ª–∞–ª–∏ –±–æ–ª–µ–µ –¥–≤—É—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö –æ—Ç–µ–ª—è—Ö –∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏
-- –±–æ–ª–µ–µ 500 –¥–æ–ª–ª–∞—Ä–æ–≤ –Ω–∞ —Å–≤–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –î–ª—è —ç—Ç–æ–≥–æ:
-- 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–¥–µ–ª–∞–ª–∏ –±–æ–ª–µ–µ –¥–≤—É—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∏ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ –Ω–æ–º–µ—Ä–∞ –≤ –±–æ–ª–µ–µ —á–µ–º –æ–¥–Ω–æ–º –æ—Ç–µ–ª–µ.
-- –í—ã–≤–µ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ: ID_customer, –∏–º—è, –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π,
-- –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–µ–ª–µ–π, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ –Ω–æ–º–µ—Ä–∞, –∏ –æ–±—â—É—é —Å—É–º–º—É, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—É—é –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

-- 2. –¢–∞–∫–∂–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –±–æ–ª–µ–µ 500 –¥–æ–ª–ª–∞—Ä–æ–≤ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è,
-- –∏ –≤—ã–≤–µ—Å—Ç–∏ –¥–ª—è –Ω–∏—Ö ID_customer, –∏–º—è, –æ–±—â—É—é —Å—É–º–º—É, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—É—é –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

-- 3. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö –ø—É–Ω–∫—Ç–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤,
-- –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —É—Å–ª–æ–≤–∏—è–º –æ–±–æ–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–ª—è: ID_customer, –∏–º—è, –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π,
-- –æ–±—â—É—é —Å—É–º–º—É, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—É—é –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–µ–ª–µ–π.
-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –æ–±—â–µ–π —Å—É–º–º–µ, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–π –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è.
WITH ClientBookings AS (
    SELECT
        c.ID_customer,
        c.name,
        COUNT(b.ID_booking) AS total_bookings,
        COUNT(DISTINCT h.ID_hotel) AS unique_hotels,
        SUM(r.price) AS total_spent
    FROM Booking b
             JOIN Customer c ON b.ID_customer = c.ID_customer
             JOIN Room r ON b.ID_room = r.ID_room
             JOIN Hotel h ON r.ID_hotel = h.ID_hotel
    GROUP BY c.ID_customer, c.name
    HAVING COUNT(b.ID_booking) > 2 AND COUNT(DISTINCT h.ID_hotel) > 1
),
     ClientSpentMoreThan500 AS (
         SELECT
             c.ID_customer,
             c.name,
             SUM(r.price) AS total_spent,
             COUNT(b.ID_booking) AS total_bookings
         FROM Booking b
                  JOIN Customer c ON b.ID_customer = c.ID_customer
                  JOIN Room r ON b.ID_room = r.ID_room
         GROUP BY c.ID_customer, c.name
         HAVING SUM(r.price) > 500
     )

SELECT
    cb.ID_customer,
    cb.name,
    cb.total_bookings,
    cb.total_spent,
    cb.unique_hotels
FROM ClientBookings cb
         JOIN ClientSpentMoreThan500 csm ON cb.ID_customer = csm.ID_customer
ORDER BY cb.total_spent;


--–í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö –≤ –æ—Ç–µ–ª—è—Ö –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç–∏–ø—É –æ—Ç–µ–ª–µ–π. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–µ–ª–µ–π.
-- –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∂–¥–æ–≥–æ –æ—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–µ–¥–Ω–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞:
--
-- ¬´–î–µ—à–µ–≤—ã–π¬ª: —Å—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–µ–Ω–µ–µ 175 –¥–æ–ª–ª–∞—Ä–æ–≤.
-- ¬´–°—Ä–µ–¥–Ω–∏–π¬ª: —Å—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç 175 –¥–æ 300 –¥–æ–ª–ª–∞—Ä–æ–≤.
-- ¬´–î–æ—Ä–æ–≥–æ–π¬ª: —Å—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–æ–ª–µ–µ 300 –¥–æ–ª–ª–∞—Ä–æ–≤.
-- –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤.
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Ç–∏–ø –æ—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —É—Å–ª–æ–≤–∏—è –Ω–∏–∂–µ:
--
-- –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ¬´–¥–æ—Ä–æ–≥–æ–π¬ª –æ—Ç–µ–ª—å, –ø—Ä–∏—Å–≤–æ–π—Ç–µ –µ–º—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´–¥–æ—Ä–æ–≥–æ–π¬ª.
-- –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç ¬´–¥–æ—Ä–æ–≥–∏—Ö¬ª –æ—Ç–µ–ª–µ–π, –Ω–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ¬´—Å—Ä–µ–¥–Ω–∏–π¬ª, –ø—Ä–∏—Å–≤–æ–π—Ç–µ –µ–º—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´—Å—Ä–µ–¥–Ω–∏–π¬ª.
-- –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç ¬´–¥–æ—Ä–æ–≥–∏—Ö¬ª –∏ ¬´—Å—Ä–µ–¥–Ω–∏—Ö¬ª –æ—Ç–µ–ª–µ–π, –Ω–æ –µ—Å—Ç—å ¬´–¥–µ—à–µ–≤—ã–µ¬ª, –ø—Ä–∏—Å–≤–æ–π—Ç–µ –µ–º—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã—Ö –æ—Ç–µ–ª–µ–π ¬´–¥–µ—à–µ–≤—ã–π¬ª.
-- –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
-- –í—ã–≤–µ–¥–∏—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
--
-- ID_customer: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞.
-- name: –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞.
-- preferred_hotel_type: –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Ç–∏–ø –æ—Ç–µ–ª—è.
-- visited_hotels: —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Å–µ—Ç–∏–ª –∫–ª–∏–µ–Ω—Ç.
-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
-- –û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ç–∞–∫, —á—Ç–æ–±—ã —Å–Ω–∞—á–∞–ª–∞ —à–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã —Å ¬´–¥–µ—à–µ–≤—ã–º–∏¬ª –æ—Ç–µ–ª—è–º–∏, –∑–∞—Ç–µ–º —Å–æ ¬´—Å—Ä–µ–¥–Ω–∏–º–∏¬ª –∏ –≤ –∫–æ–Ω—Ü–µ ‚Äî —Å ¬´–¥–æ—Ä–æ–≥–∏–º–∏¬ª.
WITH HotelCategories AS (
    SELECT
        h.ID_hotel,
        CASE
            WHEN AVG(r.price) < 175 THEN '–î–µ—à–µ–≤—ã–π'
            WHEN AVG(r.price) BETWEEN 175 AND 300 THEN '–°—Ä–µ–¥–Ω–∏–π'
            WHEN AVG(r.price) > 300 THEN '–î–æ—Ä–æ–≥–æ–π'
            END AS hotel_category
    FROM Hotel h
             JOIN Room r ON h.ID_hotel = r.ID_hotel
    GROUP BY h.ID_hotel
),
     CustomerPreferences AS (
         SELECT
             b.ID_customer,
             MAX(CASE
                     WHEN hc.hotel_category = '–î–æ—Ä–æ–≥–æ–π' THEN '–î–æ—Ä–æ–≥–æ–π'
                     WHEN hc.hotel_category = '–°—Ä–µ–¥–Ω–∏–π' THEN '–°—Ä–µ–¥–Ω–∏–π'
                     WHEN hc.hotel_category = '–î–µ—à–µ–≤—ã–π' THEN '–î–µ—à–µ–≤—ã–π'
                     ELSE NULL
                 END) AS preferred_hotel_type,
             STRING_AGG(DISTINCT h.name, ', ') AS visited_hotels
         FROM Booking b
                  JOIN Room r ON b.ID_room = r.ID_room
                  JOIN Hotel h ON r.ID_hotel = h.ID_hotel
                  JOIN HotelCategories hc ON h.ID_hotel = hc.ID_hotel
         GROUP BY b.ID_customer
     )

SELECT
    cp.ID_customer,
    c.name,
    cp.preferred_hotel_type,
    cp.visited_hotels
FROM CustomerPreferences cp
         JOIN Customer c ON cp.ID_customer = c.ID_customer
ORDER BY
    CASE cp.preferred_hotel_type
        WHEN '–î–µ—à–µ–≤—ã–π' THEN 1
        WHEN '–°—Ä–µ–¥–Ω–∏–π' THEN 2
        WHEN '–î–æ—Ä–æ–≥–æ–π' THEN 3
        END;
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
```sql
-- –ó–∞–¥–∞—á–∞ 1
-- –£—Å–ª–æ–≤–∏–µ
--
-- –ù–∞–π—Ç–∏ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –ø–æ–¥—á–∏–Ω—è—é—â–∏—Ö—Å—è –ò–≤–∞–Ω—É –ò–≤–∞–Ω–æ–≤—É (—Å EmployeeID = 1), –≤–∫–ª—é—á–∞—è –∏—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö –∏ –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö.
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤—ã–≤–µ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
--
-- EmployeeID: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
-- –ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
-- ManagerID: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
-- –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç.
-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—É—é –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç.
-- –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤, –∫ –∫–æ—Ç–æ—Ä—ã–º –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è (–µ—Å–ª–∏ –µ—Å—Ç—å, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é).
-- –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —ç—Ç–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é).
-- –ï—Å–ª–∏ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–ª–∏ –∑–∞–¥–∞—á, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å NULL.
-- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
--
-- –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏–∑–≤–ª–µ—á—å –≤—Å–µ—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ò–≤–∞–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞ –∏ –∏—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö.
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü.
-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∏–º–µ–Ω–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
-- –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –∏–∑ —Å–µ–±—è –æ–¥–∏–Ω sql-–∑–∞–ø—Ä–æ—Å –∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ RECURSIVE.

WITH RECURSIVE subordinates AS (
    SELECT
        EmployeeID,
        Name,
        ManagerID,
        DepartmentID,
        RoleID
    FROM
        Employees
    WHERE
        ManagerID = 1
    UNION ALL
    SELECT
        e.EmployeeID,
        e.Name,
        e.ManagerID,
        e.DepartmentID,
        e.RoleID
    FROM
        Employees e
    JOIN subordinates s ON e.ManagerID = s.EmployeeID
)
SELECT
    s.EmployeeID,
    s.Name,
    s.ManagerID,
    d.DepartmentName AS Department,
    r.RoleName AS Role,
    (SELECT
        STRING_AGG(p.ProjectName, ', ')
    FROM projects p
        WHERE p.DepartmentID = s.DepartmentID
    ) projects,
    (
     SELECT STRING_AGG(t.TaskName, ', ')
        FROM Tasks t
     WHERE t.AssignedTo = s.EmployeeID
    ) tasks
FROM
    Subordinates s
        JOIN Departments d ON s.DepartmentID = d.DepartmentID
        JOIN Roles r ON s.RoleID = r.RoleID
ORDER BY s.Name;


-- –ó–∞–¥–∞—á–∞ 2
-- –£—Å–ª–æ–≤–∏–µ
--
-- –ù–∞–π—Ç–∏ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –ø–æ–¥—á–∏–Ω—è—é—â–∏—Ö—Å—è –ò–≤–∞–Ω—É –ò–≤–∞–Ω–æ–≤—É —Å EmployeeID = 1, –≤–∫–ª—é—á–∞—è –∏—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö –∏ –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö.
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤—ã–≤–µ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
--
-- EmployeeID: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
-- –ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
-- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
-- –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç.
-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—É—é –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç.
-- –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤, –∫ –∫–æ—Ç–æ—Ä—ã–º –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è (–µ—Å–ª–∏ –µ—Å—Ç—å, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ).
-- –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —ç—Ç–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ).
-- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —ç—Ç–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É.
-- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö —É –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–Ω–µ –≤–∫–ª—é—á–∞—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö –∏—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö).
-- –ï—Å–ª–∏ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–ª–∏ –∑–∞–¥–∞—á, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å NULL.
WITH RECURSIVE Subordinates AS (
    SELECT EmployeeID, ManagerID, Name, DepartmentID, RoleID
    FROM Employees
    WHERE ManagerID = 1

    UNION ALL

    SELECT e.EmployeeID,
           e.ManagerID,
           e.Name,
           e.DepartmentID,
           e.RoleID
    FROM Employees e
             INNER JOIN Subordinates s ON e.ManagerID = s.EmployeeID
),
               SubordinateCount AS (
                   SELECT ManagerID, COUNT(*) as DirectSubordinates
                   FROM Employees
                   WHERE ManagerID IS NOT NULL
                   GROUP BY ManagerID
               ),
               ProjectAggregation AS (
                   SELECT
                       e.EmployeeID,
                       STRING_AGG(p.ProjectName, ', ') as Projects
                   FROM Subordinates e
                            LEFT JOIN Tasks t ON e.EmployeeID = t.AssignedTo
                            LEFT JOIN Projects p ON t.ProjectID = p.ProjectID
                   GROUP BY e.EmployeeID
               ),
               TaskAggregation AS (
                   SELECT
                       e.EmployeeID,
                       STRING_AGG(t.TaskName, ', ') as Tasks,
                       COUNT(t.TaskID) as TaskCount
                   FROM Subordinates e
                            LEFT JOIN Tasks t ON e.EmployeeID = t.AssignedTo
                   GROUP BY e.EmployeeID
               )
SELECT
    s.EmployeeID,
    s.Name EmployeeName,
    s.ManagerID,
    d.DepartmentName,
    r.RoleName,
    NULLIF(pa.Projects, ''),
    NULLIF(ta.Tasks, ''),
    ta.TaskCount,
    COALESCE(sc.DirectSubordinates, 0)
FROM Subordinates s
         LEFT JOIN Departments d ON s.DepartmentID = d.DepartmentID
         LEFT JOIN Roles r ON s.RoleID = r.RoleID
         LEFT JOIN ProjectAggregation pa ON s.EmployeeID = pa.EmployeeID
         LEFT JOIN TaskAggregation ta ON s.EmployeeID = ta.EmployeeID
         LEFT JOIN SubordinateCount sc ON s.EmployeeID = sc.ManagerID
ORDER BY EmployeeName;


-- –ó–∞–¥–∞—á–∞ 3
-- –£—Å–ª–æ–≤–∏–µ
--
-- –ù–∞–π—Ç–∏ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–Ω–∏–º–∞—é—Ç —Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∏–º–µ—é—Ç –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö (—Ç–æ –µ—Å—Ç—å —á–∏—Å–ª–æ –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ 0).
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤—ã–≤–µ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
--
-- EmployeeID: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
-- –ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
-- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
-- –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç.
-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—É—é –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç.
-- –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤, –∫ –∫–æ—Ç–æ—Ä—ã–º –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è (–µ—Å–ª–∏ –µ—Å—Ç—å, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ).
-- –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —ç—Ç–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ).
-- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö —É –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤–∫–ª—é—á–∞—è –∏—Ö –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã—Ö).
-- –ï—Å–ª–∏ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–ª–∏ –∑–∞–¥–∞—á, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å NULL.
WITH RECURSIVE Subordinates AS (
    SELECT EmployeeID, ManagerID
    FROM Employees
    WHERE ManagerID IS NOT NULL

    UNION ALL

    SELECT e.EmployeeID, s.ManagerID
    FROM Employees e
             INNER JOIN Subordinates s ON e.ManagerID = s.EmployeeID
),
               SubordinateCount AS (
                   SELECT
                       ManagerID,
                       COUNT(DISTINCT EmployeeID) as TotalSubordinates
                   FROM Subordinates
                   GROUP BY ManagerID
               ),
               ProjectAggregation AS (
                   SELECT
                       e.EmployeeID,
                       STRING_AGG(p.ProjectName, ', ') as Projects
                   FROM Employees e
                            LEFT JOIN Tasks t ON e.EmployeeID = t.AssignedTo
                            LEFT JOIN Projects p ON t.ProjectID = p.ProjectID
                   GROUP BY e.EmployeeID
               ),
               TaskAggregation AS (
                   SELECT
                       e.EmployeeID,
                       STRING_AGG(t.TaskName, ', ') as Tasks
                   FROM Employees e
                            LEFT JOIN Tasks t ON e.EmployeeID = t.AssignedTo
                   GROUP BY e.EmployeeID
               )

SELECT
    e.EmployeeID,
    e.Name EmployeeName,
    e.ManagerID,
    d.DepartmentName,
    r.RoleName,
    NULLIF(pa.Projects, ''),
    NULLIF(ta.Tasks, ''),
    sc.TotalSubordinates
FROM Employees e
         JOIN Roles r ON e.RoleID = r.RoleID
         JOIN Departments d ON e.DepartmentID = d.DepartmentID
         JOIN SubordinateCount sc ON e.EmployeeID = sc.ManagerID
         LEFT JOIN ProjectAggregation pa ON e.EmployeeID = pa.EmployeeID
         LEFT JOIN TaskAggregation ta ON e.EmployeeID = ta.EmployeeID
WHERE r.RoleName ILIKE '%–º–µ–Ω–µ–¥–∂–µ—Ä%'
ORDER BY EmployeeName;
```
